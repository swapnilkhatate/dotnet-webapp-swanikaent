trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  azuresubscription: 'WebApp-Azure-DevOps'
  resourceGroupName: 'My-RG'
  appServiceName: 'dotnetwebapp-swanikaent'
  packagePath: '$(System.DefaultWorkingDirectory)'

stages: 
 - stage: Build
    displayName: 'Build Stage'
    jobs: 
    - job: Build
      displayName: 'Build Job'
      steps:
       - task: UseDotNet@2
         inputs:
           packageType: 'sdk'
           version: '10.0.x'
           
       - task: DotNetCoreCLI@2
         displayName: 'Restore NuGet Packages'
         inputs:
           command: 'restore'
           projects: '**/*.csproj'

       - task: DotNetCoreCLI@2
         displayName: 'Build Solution'
         inputs:
           command: 'build'
           projects: '**/*.csproj'
           arguments: '--configuration $(buildConfiguration)'

       - task: DotNetCoreCLI@2
         displayName: 'Run Unit Tests'
         inputs:
           command: 'test'
           projects: '**/*Tests/*.csproj'
           arguments: '--configuration $(buildConfiguration) --no-build --collect:"Code Coverage"'

       - task: DotNetCoreCLI@2
         displayName: 'Publish Application'
         inputs:
           command: 'publish'
           projects: '**/*.csproj'
           arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'

       - task: PublishBuildArtifacts@1
         displayName: 'Publish Artifacts'
         inputs:
           PathtoPublish: '$(Build.ArtifactStagingDirectory)'
           ArtifactName: 'drop'
           publishLocation: 'Container'

 - stage: Deploy
   displayName: 'Deploy Stage'
   dependsOn: Build
   jobs:
   - deployment: Deploy
     displayName: 'Deploy Job'
     environment: 'production'
     strategy:
       runOnce:
         deploy:
           steps:
           - task: AzureWebApp@1
             displayName: 'Deploy to Azure Web App'
             inputs:
               azureSubscription: '$(azuresubscription)'
               appType: 'webApp'
               appName: '$(appServiceName)'
               package: '$(packagePath)/drop'